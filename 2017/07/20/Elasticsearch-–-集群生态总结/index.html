<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Es – 集群生态总结 | 斑斓的梦</title>
    
    
        <meta name="keywords" content="Elasticsearch,Es,集群" />
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="分片算法:1shard = hash(routing) % number_of_primary_shards routing值是一个任意字符串，它默认是_id但也可以自定义，这个routing字符串通过哈希函数生成一个数字，然后除以主切片的数量得到一个余数(remainder)，余数的范围永远是0到number_of_primary_shards – 1，这个数字就是特定文档所在的分片。 这也解释">
<meta name="keywords" content="Elasticsearch,Es,集群">
<meta property="og:type" content="article">
<meta property="og:title" content="Es – 集群生态总结">
<meta property="og:url" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/index.html">
<meta property="og:site_name" content="斑斓的梦">
<meta property="og:description" content="分片算法:1shard = hash(routing) % number_of_primary_shards routing值是一个任意字符串，它默认是_id但也可以自定义，这个routing字符串通过哈希函数生成一个数字，然后除以主切片的数量得到一个余数(remainder)，余数的范围永远是0到number_of_primary_shards – 1，这个数字就是特定文档所在的分片。 这也解释">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301445145908370.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301447481842914.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301448224189287.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301450312776822.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301452193242213.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301453316066030.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301454200908450.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301455187779322.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301455447626616.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301456308712196.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301457315278966.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301458043873327.png">
<meta property="og:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301459413712397.png">
<meta property="og:updated_time" content="2017-07-20T09:28:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Es – 集群生态总结">
<meta name="twitter:description" content="分片算法:1shard = hash(routing) % number_of_primary_shards routing值是一个任意字符串，它默认是_id但也可以自定义，这个routing字符串通过哈希函数生成一个数字，然后除以主切片的数量得到一个余数(remainder)，余数的范围永远是0到number_of_primary_shards – 1，这个数字就是特定文档所在的分片。 这也解释">
<meta name="twitter:image" content="http://pzhen.github.io/2017/07/20/Elasticsearch-–-集群生态总结/301445145908370.png">
    

    

    
        <link rel="icon" href="/css/images/favicon.ico" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">
    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">斑斓的梦</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/woailuo.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Buscar" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Entradas',
            PAGES: 'Pages',
            CATEGORIES: 'Categorias',
            TAGS: 'Etiquetas',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Buscar" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/woailuo.jpg" />
            <h2 id="name">P.Zhen</h2>
            <h3 id="title">Designer &amp; Programmer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Bei Jing, China</span>
            <a id="follow" target="_blank" href="https://github.com/pzhen/">SEGUIR</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                29
                <span>Entradas</span>
            </div>
            <div class="article-info-block">
                35
                <span>Etiquetas</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/pzhen/" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="3stack-overflow" class=tooltip>
                            <i class="fa fa-3stack-overflow"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id='categories'>
        <h3 class="widget-title">
            <span>Categorias</span>
            &nbsp;
            <a id='allExpand' href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Composer
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/21/Composer-管理PHP依赖关系/">Composer - 管理PHP依赖</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            Elasticsearch
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/20/Elasticsearch-–-Ik-分词器/">Es – Ik 分词器</a></li>  <li class="file"><a href="/2017/07/20/Elasticsearch-–-倒排索引/">Es – 倒排索引</a></li>  <li class="file"><a href="/2017/07/21/Elasticsearch-–-单机多节点集群/">Es - 单机多节点集群</a></li>  <li class="file"><a href="/2017/07/20/Elasticsearch-–-安装/">Es – 安装</a></li>  <li class="file"><a href="/2017/07/21/Elasticsearch-–-安装插件/">Es – 安装插件</a></li>  <li class="file"><a href="/2017/07/20/Elasticsearch-–-核心概念/">Es – 核心概念</a></li>  <li class="file active"><a href="/2017/07/20/Elasticsearch-–-集群生态总结/">Es – 集群生态总结</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Git
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/21/Git-–-全局配置与局部项目配置/">Git – 全局与局部项目配置</a></li>  <li class="file"><a href="/2017/07/21/Git-–-基本工作流程/">Git – 基本工作流程</a></li>  <li class="file"><a href="/2017/07/21/Git-–-操作配置别名/">Git – 操作配置别名</a></li>  <li class="file"><a href="/2017/07/21/Git-–-集中式与分布式-版本控制系统区别/">Git – 集中式与分布式</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Hexo
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/21/Hexo-–-Deployer-not-found/">Hexo – 'Deployer not found'</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Linux
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Jdk
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/20/Jdk-Ubuntu安装/">Jdk - Ubuntu安装</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Maven
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/21/Maven-Mac-安装/">Maven - Mac 安装</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Shell
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/21/Shell-–-Grep常见用法/">Shell – Grep 常见用法</a></li>  <li class="file"><a href="/2017/07/19/Shell-–-Svn-Log/">Shell – Svn Log</a></li>  <li class="file"><a href="/2017/07/20/Shell-–-Mac-zsh/">Shell – Mac zsh</a></li>  <li class="file"><a href="/2017/07/19/Shell-–-SSH自动登录/">Shell – SSH自动登录</a></li>  <li class="file"><a href="/2017/07/20/Shell-–-item2-配色/">Shell – item2 配色</a></li>  <li class="file"><a href="/2017/07/21/Shell-–-正则表达式/">Shell – 正则表达式</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Vim
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/20/Vim-colorschemes/">Vim colorschemes</a></li>  <li class="file"><a href="/2017/07/19/Vim-常用命令/">Vim 常用命令</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Php
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/31/Php-Api通信规则/">Php 一Api通信规则</a></li>  <li class="file"><a href="/2017/07/20/Php-实现一致性哈希包含虚拟节点/">Php 一致性哈希</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Python
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/21/Python-优先级队列/">Python 优先级队列</a></li>  <li class="file"><a href="/2017/07/20/Python-中文编码问题/">Python 中文编码问题</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Redis
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2017/07/20/Redis-PHP7扩展/">Redis - PHP7扩展</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/2017/07/19/Linux下-ssh-自动登录脚本/"></a></li>  </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-Elasticsearch-–-集群生态总结" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Elasticsearch/">Elasticsearch</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Elasticsearch/">Elasticsearch</a>, <a class="tag-link" href="/tags/Es/">Es</a>, <a class="tag-link" href="/tags/集群/">集群</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/20/Elasticsearch-–-集群生态总结/">
            <time datetime="2017-07-20T09:05:22.000Z" itemprop="datePublished">2017-07-20</time>
        </a>
    </div>


                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            Es – 集群生态总结
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
                <div id="toc" class="toc-article">
                <strong class="toc-title">Catálogo</strong>
                    <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#分片算法"><span class="toc-number">1.</span> <span class="toc-text">分片算法:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#增删改（write）执行过程"><span class="toc-number">2.</span> <span class="toc-text">增删改（write）执行过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#副本分片复制时的相关的参数说明"><span class="toc-number">3.</span> <span class="toc-text">副本分片复制时的相关的参数说明:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#集群生态"><span class="toc-number">4.</span> <span class="toc-text">集群生态:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#集群健康"><span class="toc-number">5.</span> <span class="toc-text">集群健康:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#单机多节点来了解ES的高可用"><span class="toc-number">6.</span> <span class="toc-text">单机多节点来了解ES的高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建单集群节点"><span class="toc-number">6.1.</span> <span class="toc-text">创建单集群节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#增加故障转移"><span class="toc-number">6.2.</span> <span class="toc-text">增加故障转移</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#模拟节点宕机-集群主从重新选举"><span class="toc-number">6.3.</span> <span class="toc-text">模拟节点宕机,集群主从重新选举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#模拟扩展节点"><span class="toc-number">6.4.</span> <span class="toc-text">模拟扩展节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#动态缩小或者扩容副本片数量"><span class="toc-number">6.5.</span> <span class="toc-text">动态缩小或者扩容副本片数量</span></a></li></ol></li></ol>
                </div>
            
        
        
            <h4 id="分片算法"><a href="#分片算法" class="headerlink" title="分片算法:"></a>分片算法:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shard = hash(routing) % number_of_primary_shards</div></pre></td></tr></table></figure>
<p>routing值是一个任意字符串，它默认是_id但也可以自定义，这个routing字符串通过哈希函数生成一个数字，然后除以主切片的数量得到一个余数(remainder)，余数的范围永远是0到number_of_primary_shards – 1，这个数字就是特定文档所在的分片。</p>
<p>这也解释了为什么主切片的数量只能在创建索引时定义且不能修改：如果主切片的数量在未来改变了，所有先前的路由值就失效了，文档也就永远找不到了。</p>
<p>所有的文档API（get、index、delete、bulk、update、mget）都接收一个routing参数，它用来自定义文档到分片的映射。自定义路由值可以确保所有相关文档.比如用户的文章,按照用户账号路由,就可以实现属于同一用户的文档被保存在同一分片上。</p>
<h4 id="增删改（write）执行过程"><a href="#增删改（write）执行过程" class="headerlink" title="增删改（write）执行过程"></a>增删改（write）执行过程</h4><p>不管是索引，还是文档的write操作，它们必须在主分片上成功完成才能复制到相关的复制分片上,下面我们罗列在主分片和复制分片上成功新建、索引或删除一个文档必要的顺序步骤：</p>
<p>1、客户端给Node 1发送新建、索引或删除请求。</p>
<p>2、节点使用文档的_id确定文档属于分片0。它转发请求到Node 3，分片0位于这个节点上。</p>
<p>3、Node 3在主分片上执行请求，如果成功，它转发请求到相应的位于Node 1和Node 2的复制节点上。当所有的复制节点报告成功，Node 3报告成功到请求的节点，请求的节点再报告给客户端。</p>
<p>客户端接收到成功响应的时候，文档的修改已经被应用于主分片和所有的复制分片。你的修改生效了。</p>
<h4 id="副本分片复制时的相关的参数说明"><a href="#副本分片复制时的相关的参数说明" class="headerlink" title="副本分片复制时的相关的参数说明:"></a>副本分片复制时的相关的参数说明:</h4><p>replication:</p>
<p>复制默认的值是sync。这将导致主分片得到复制分片的成功响应后才返回，如果你设置replication为async，请求在主分片上被执行后就会返回给客户端。它依旧会转发请求给复制节点，但你将不知道复制节点成功与否。</p>
<p>默认的sync复制允许Elasticsearch强制反馈传输。async复制可能会因为在不等待其它分片就绪的情况下发送过多的请求而使Elasticsearch过载。</p>
<p>consistency:</p>
<p>默认主分片在尝试写入时需要<strong>规定数量(quorum)</strong>或过半的分片（可以是主节点或复制节点）可用。这是防止数据被写入到错的网络分区。规定的数量计算公式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int( (primary + number_of_replicas) / 2 ) + 1</div></pre></td></tr></table></figure></p>
<p>consistency允许的值为one（只有一个主分片），all（所有主分片和复制分片）或者默认的quorum或过半分片。</p>
<p>注意number_of_replicas是在索引中的的设置，用来定义复制分片的数量，而不是现在活动的复制节点的数量。如果你定义了索引有3个复制节点，那规定数量是：int( (primary + 3 replicas) / 2 ) + 1 = 3</p>
<p>但如果你只有2个节点，那你的活动分片不够规定数量，也就不能索引或删除任何文档。</p>
<p>注意: 新索引默认有1个复制分片，这意味着为了满足quorum的要求<strong>需要</strong>两个活动的分片。当然，这个默认设置将阻止我们在单一节点集群中进行操作。为了避开这个问题，规定数量只有在number_of_replicas大于一时才生效。</p>
<p>timeout：</p>
<p>当分片副本不足时Elasticsearch会等待更多的分片出现。默认等待一分钟。如果需要，你可以设置timeout参数让它终止的更早：100表示100毫秒，30s表示30秒。</p>
<h4 id="集群生态"><a href="#集群生态" class="headerlink" title="集群生态:"></a>集群生态:</h4><p>1.同集群中节点之间可以扩容缩容,</p>
<p>2.主分片的数量会在其索引创建完成后修正，但是副本分片的数量会随时变化。</p>
<p>3.相同的分片不会放在同一个节点上.</p>
<h4 id="集群健康"><a href="#集群健康" class="headerlink" title="集群健康:"></a>集群健康:</h4><p>在Elasticsearch集群中可以监控统计很多信息，但是只有一个是最重要的时集群健康(cluster health)。Es中用三种颜色状态表示:green，yellow，red.</p>
<p>Green：所有主分片和副本分片都可用</p>
<p>Yellow：所有主分片可用，但不是所有副本分片都可用</p>
<p>Red：不是所有的主分片都可用；</p>
<h4 id="单机多节点来了解ES的高可用"><a href="#单机多节点来了解ES的高可用" class="headerlink" title="单机多节点来了解ES的高可用"></a>单机多节点来了解ES的高可用</h4><h5 id="创建单集群节点"><a href="#创建单集群节点" class="headerlink" title="创建单集群节点"></a>创建单集群节点</h5><p>如图我们的单点集群:<br><img src="301445145908370.png" alt="es-node1"></p>
<p>实例中我们创建一个索引dobbyindex.一个索引默认指派5个主分片,实例中我们设定4个主分片和2个复制分片（每个主分片有2个复制分片对应）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">PUT /dobbyindex</div><div class="line">&#123;</div><div class="line">  &quot;settings&quot;: &#123;</div><div class="line">    &quot;number_of_shards&quot;: 4,</div><div class="line">    &quot;number_of_replicas&quot;: 2</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建后索引如图:</p>
<p><img src="301447481842914.png" alt="image"></p>
<p>在节点es-node1中片的存放如下:</p>
<p><img src="301448224189287.png" alt="image"></p>
<p>我们的主分片都被分配到了es-node1.但是我们的8个复制分片还没有被分配到节点上, 此时的集群健康状况如下:</p>
<p>cluster health: yellow (4 of 12)<br>对应的详细信息为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;cluster_name&quot;: &quot;elasticsearch-cluster-centos&quot;,</div><div class="line">    &quot;status&quot;: &quot;yellow&quot;,</div><div class="line">    &quot;timed_out&quot;: false,</div><div class="line">    &quot;number_of_nodes&quot;: 1,</div><div class="line">    &quot;number_of_data_nodes&quot;: 1,</div><div class="line">    &quot;active_primary_shards&quot;: 4,</div><div class="line">    &quot;active_shards&quot;: 4,</div><div class="line">    &quot;relocating_shards&quot;: 0,</div><div class="line">    &quot;initializing_shards&quot;: 0,</div><div class="line">    &quot;unassigned_shards&quot;: 8</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>意味着所有的主分片(primary shards)启动并且运行了,集群已经可以成功的接受任意请求,但是副本分片(replica shards)还没有全部可用。<br>事实上所有的8个副本分片现在是unassigned（未分配）状态,即它们还未被分配给节点,在同一个节点上保存相同的数据副本是没有必要的，如果这个节点故障了，那所有的数据副本也会丢失。现在我们的集群已经功能完备，但是依旧存在因硬件故障而导致的数据丢失的风险。</p>
<h5 id="增加故障转移"><a href="#增加故障转移" class="headerlink" title="增加故障转移"></a>增加故障转移</h5><p>上面实例中的集群有单点故障的风险,没有数据冗余备份。我们可以扩展节点来保护数据不被丢失.只要第二个节点与第一个节点有相同的cluster.name(实例中为elasticsearch-cluster-centos)，它就能自动发现并加入第一个节点的集群。</p>
<p>如果没有，检查日志找出哪里出了问题。这可能是网络广播被禁用，或者防火墙阻止了节点通信。</p>
<p>当我们启动第二个节点之后:集群中的分片结构图如下:</p>
<p><img src="301450312776822.png" alt="image"></p>
<p>虽然,已经有4个副本分片被分陪到es-node2节点上来了，但是按照我们定义的副本分片的值为2, 还有4个分片处于未分片状态,此时对于我们设定的参数来说,集群的健康值还是所有主分片可用，但不是所有复制分片都可用. 对应的集群健康状况:</p>
<p>cluster health: yellow (8 of 12)</p>
<p>对应的详细信息为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;cluster_name&quot;: &quot;elasticsearch-cluster-centos&quot;,</div><div class="line">    &quot;status&quot;: &quot;yellow&quot;,</div><div class="line">    &quot;timed_out&quot;: false,</div><div class="line">    &quot;number_of_nodes&quot;: 2,</div><div class="line">    &quot;number_of_data_nodes&quot;: 2,</div><div class="line">    &quot;active_primary_shards&quot;: 4,</div><div class="line">    &quot;active_shards&quot;: 8,</div><div class="line">    &quot;relocating_shards&quot;: 0,</div><div class="line">    &quot;initializing_shards&quot;: 0,</div><div class="line">    &quot;unassigned_shards&quot;: 4</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以我们还需要一个节点来分片这些副本分片,使集群达到高可用,再增加集群节点:</p>
<p><img src="301452193242213.png" alt="image"></p>
<p>当我们启动第三个节点之后,整个集群上的分片都进行了有效分配,从图中可以看出.es-node1为这个集群生态中选举出来的主(master),es-node2和es-node3为集群生态中的slave(从). 这样,一些新的被索引的文档将首先被存储在主分片中，然后平行复制到关联的复制节点上。这可以确保我们的数据在主节点和复制节点上都可以被检索。</p>
<p>此时集群的健康状态如下：</p>
<p>cluster health: green (12 of 12)<br>对应的详细信息为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;cluster_name&quot;: &quot;elasticsearch-cluster-centos&quot;,</div><div class="line">    &quot;status&quot;: &quot;green&quot;,</div><div class="line">    &quot;timed_out&quot;: false,</div><div class="line">    &quot;number_of_nodes&quot;: 3,</div><div class="line">    &quot;number_of_data_nodes&quot;: 3,</div><div class="line">    &quot;active_primary_shards&quot;: 4,</div><div class="line">    &quot;active_shards&quot;: 12,</div><div class="line">    &quot;relocating_shards&quot;: 0,</div><div class="line">    &quot;initializing_shards&quot;: 0,</div><div class="line">    &quot;unassigned_shards&quot;: 0</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下图为,节点es-node3加入时,分片分配过程中截取的临时图.</p>
<p><img src="301453316066030.png" alt="image"></p>
<h5 id="模拟节点宕机-集群主从重新选举"><a href="#模拟节点宕机-集群主从重新选举" class="headerlink" title="模拟节点宕机,集群主从重新选举"></a>模拟节点宕机,集群主从重新选举</h5><p>上图中我们的主节点为es-node1,如果主节点宕掉后,会怎样呢.</p>
<p><img src="301454200908450.png" alt="image"></p>
<p>如图:主节点对应的进程号7421,干掉它，此时es集群生态发生了如下变化,如图:</p>
<p><img src="301455187779322.png" alt="image"></p>
<p>es-node3被选举为主节点,es-node2为从节点,主分片与副本分片也变化了,主分片放置在了es-node2上,副本分片放置到了es-node3上,因为分片没有完全被分配,所以集群的健康状态变为yellow(所有主分片可用，但不是所有复制分片都可用),然后我们重启es-node1节点.</p>
<p><img src="301455447626616.png" alt="image"></p>
<p>如图,重启后健康状态恢复到green,但是集群主从变化了,且主分片的位置也变化了.</p>
<h5 id="模拟扩展节点"><a href="#模拟扩展节点" class="headerlink" title="模拟扩展节点"></a>模拟扩展节点</h5><p><img src="301456308712196.png" alt="iamge"></p>
<p>实例2中我们的集群已经达到高可用状态,对应的索引分片如图.此时我们想要扩展集群继续增加节点时,我们的分片会怎样呢,接下来我们再增加一个扩展节点es-node4.</p>
<p><img src="301457315278966.png" alt="iamge"></p>
<p>如图:扩容后,可以看到片进行了重新分片,节点es-node1和es-node3上分别持有主分片。es-node2,es-node3,es-node4持有副本分片，由于笔者模拟过程中有主节点宕机操作,</p>
<p>所以从图中可以看出,新的生态集群中es-node4为主节点.对应的各个集群存储中包含的片分布信息如下:</p>
<p><img src="301458043873327.png" alt="iamge"></p>
<p>这种状态下的片也是完全分配，green(所有主要和复制的分片都可用).</p>
<h5 id="动态缩小或者扩容副本片数量"><a href="#动态缩小或者扩容副本片数量" class="headerlink" title="动态缩小或者扩容副本片数量"></a>动态缩小或者扩容副本片数量</h5><p>副本节点的数量可以在运行中的集群中动态的变更，这允许我们可以根据需求扩大或者缩小规模。</p>
<p>比如我们执行一次缩小规模操作:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">PUT /dobbyindex/_settings</div><div class="line">&#123;</div><div class="line">   &quot;number_of_replicas&quot; : 1</div><div class="line">&#125;</div><div class="line">执行结果返回:</div><div class="line">&#123;</div><div class="line">    &quot;acknowledged&quot;: true</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这时,我们看到片的信息分又重新做了调整: 主分片分布在节点es-node1,es-node3,es-node4上.从分片分布在es-node2,es-node3,es-node4上.</p>
<p><img src="301459413712397.png" alt="image"></p>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/2017/07/21/Hexo-–-Deployer-not-found/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Más nuevo</strong>
            <div class="article-nav-title">
                
                    Hexo – &#39;Deployer not found&#39;
                
            </div>
        </a>
    
    
        <a href="/2017/07/20/Elasticsearch-–-倒排索引/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Más viejo</strong>
            <div class="article-nav-title">Es – 倒排索引</div>
        </a>
    
</nav>





    
    


</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            P.Zhen &copy; 2017 Powered by <a href="http://github.com/" target="_blank">GitHub</a>.
        </div>
    </div>
</footer>
        

    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>